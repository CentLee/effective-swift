# item48. 스트림 병렬화는 주의해서 적용하라

> 

자바에서 스트림을 이용할 때 성능 최적화의 수단으로 파이프라인을 병렬화합니다. 이번 아이템에서는 스위프트에서는 어떤식으로 병렬화 작업을 하는지 알아봅시다.

주로 다량의 작업을 반복적으로 수행하는 경우 병렬화 작업이 필요하게 됩니다. 이럴 때 애플에서 제공해주는 `DispatchQueue.concurrentPerform` 메서드를 이용할 수 있는데요, 이는 명시적으로 병렬 프로그래밍을 하는 방법입니다. 

```swift
/*
 - Parameter:
	- iterations: 블록을 실행할 횟수입니다. 반복 값이 높을수록 시스템은 여러 코어에서보다 효율적으로 균형을 맞출 수 있습니다.
	- work: 병렬로 실행할 블록입니다. 이 블록에는 반환 값이 없으며 다음 매개 변수를 사용합니다.
*/
class func concurrentPerform(iterations: Int, execute work: (Int) -> Void)
```

이 방법은 효율적인 parallel for-loop를 구현합니다. 디스패치 큐는 제출된 블록을 지정된 횟수만큼 실행하고 반환하기 전에 모든 반복이 완료 될 때까지 기다립니다.(모든 작업이 완료된 경우에만 결과가 반환됩니다.) 대상 큐가 concurrentQueue인 경우 블록은 병렬로 실행되므로 재진입이 안전해야합니다.



코어가 3개인 경우에 iterations를 3으로 설정한 경우 아래 그림처럼 배분이 됩니다. 그럼 두번째 코어는 놀게되어 효율이 조금 떨어지게 됩니다.

<img width=80% src="https://user-images.githubusercontent.com/40784518/105522183-430a0980-5d20-11eb-9eb4-4edf29b3579c.png"/>



iterations을 조금 올려 11로 설정하면 아래 그림처럼 각 코어에 일감이 적절하게 배분된 것을 볼 수 있습니다.

<img width=80% src="https://user-images.githubusercontent.com/40784518/105522312-6c2a9a00-5d20-11eb-8dd6-bf7fd0db1ea4.png"/>



주어진 작업량에 대한 최적의 반복 횟수를 파악할 때 주의해야합니다. 많은 반복과 반복당 소량의 작업은 너무 많은 오버 헤드를 생성하고 컨텍스트 스위칭이 다량 발생해 동시 호출로 인한 장점을 무효화 할 수 있습니다. 



데이터를 global큐를 이용해 concurrentPerform로 병렬적으로 받아오고

다 받아오면 한번에 결과가 리턴되니까 이때 메인에 디스패치 하면 좀더 빠르게 ui를 업뎃할 수 있겠군..

왜냐면 메인큐에서 실행하게되면 동기적으로 가니까 데드락이 발생할 가능성이 높아짐..

